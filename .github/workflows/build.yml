name: Build Media Gallery Launcher

on:
  push:
  #workflow_dispatch:
  
  
  
  #pull_request:
    #branches: [ main ]
  

jobs:
  build-go-server:
    name: Build Go Server for ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            goos: windows
            goarch: amd64
            platform: windows-amd64
          - os: windows-latest
            goos: windows
            goarch: arm64
            platform: windows-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: |
          cd server
          go mod download
          go mod verify

      - name: Build Go server
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          cd server
          go build -ldflags="-s -w -X main.Version=${{ github.ref_name }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o server.exe .
          dir

      - name: Upload Go server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.platform }}
          path: server/server.exe
          retention-days: 1

  build-launcher:
    name: Build Launcher for ${{ matrix.platform }}
    needs: build-go-server
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - platform: windows-amd64
            output: MediaBrowser.exe
            goarch: amd64
          - platform: windows-arm64
            output: MediaBrowser-arm64.exe
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Go server
        uses: actions/download-artifact@v4
        with:
          name: server-${{ matrix.platform }}
          path: server/

      - name: Install MinGW
        run: |
          choco install mingw --version=11.2.0 --force -y
          $env:PATH = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin;$env:PATH"
          gcc --version

      - name: Verify server.exe exists
        run: |
          dir server
          if (!(Test-Path "server\server.exe")) {
            throw "server.exe not found!"
          }

      - name: Build resource file
        shell: cmd
        run: |
          cd launcher
          windres resource.rc -O coff -o resource.res
          if errorlevel 1 exit /b 1
          dir

      - name: Build C launcher
        shell: cmd
        run: |
          cd launcher
          gcc -v
          gcc -O3 -s -static -mwindows -o ..\${{ matrix.output }} launcher.c resource.res -lshlwapi -lole32
          if errorlevel 1 exit /b 1
          cd ..
          dir

      - name: Verify build
        run: |
          if (!(Test-Path "${{ matrix.output }}")) {
            throw "Launcher build failed - ${{ matrix.output }} not found!"
          }
          $size = (Get-Item "${{ matrix.output }}").Length / 1MB
          Write-Host "Build successful! Size: $([math]::Round($size, 2)) MB"

      - name: Create portable package
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item ${{ matrix.output }} dist/
          
          @"
          Media Gallery Launcher
          ======================
          This Version is to work with JSONs -- 
          Usage:
          1. Copy this executable to any folder containing images/videos
          2. Double-click to launch
          3. Browser will open automatically with your gallery
          
          Supported formats:
          - Images: JPG, PNG, WebP, GIF, BMP
          - Videos: MP4, WebM, OGG, MOV, AVI
          
          Keyboard shortcuts in gallery:
          - Arrow keys / A/D: Navigate
          - Space: Play/Pause slideshow
          - Escape: Close fullscreen
          - Mouse wheel: Adjust speed
          
          Version: ${{ github.ref_name }}
          Github Run ${{ $GITHUB_RUN_NUMBER}}
          Built: $(Get-Date -Format "yyyy-MM-dd HH:mm") UTC
          "@ | Out-File -FilePath dist\README.txt -Encoding UTF8

      - name: Calculate checksums
        run: |
          cd dist
          $hash = Get-FileHash ${{ matrix.output }} -Algorithm SHA256
          "$($hash.Hash)  ${{ matrix.output }}" | Out-File -FilePath "${{ matrix.output }}.sha256" -Encoding ASCII

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: dist/*
          retention-days: 30

   

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-launcher]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: |
          ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
         body: |
            ## Media Gallery Launcher ${{ github.ref_name }} (Build ${{ github.run_number }})
            
            ### üì• Downloads
            - **Windows (x64)**: MediaGallery.exe
            - **Windows (ARM64)**: MediaGallery-arm64.exe
            
            ### ‚ú® Features
            - üöÄ Single executable - no installation needed
            - üîí HTTPS server with auto-generated certificates
            - üé® Beautiful masonry gallery layout
            - ‚ö° Custom mouse gestures for navigation
            - üé¨ Slideshow mode with adjustable speed
            - üìÅ Automatic folder organization
            - üîÑ Shuffle with viewed tracking
            
            ### üéØ Usage
            1. Download the executable for your platform
            2. Drop it into any folder with images/videos
            3. Double-click to launch
            4. Gallery opens automatically in your browser at https://localhost:8443
            5. Accept the security warning (self-signed certificate)
            
            ### üêõ Known Issues
            - Browser will show security warning (expected - self-signed cert)
            - Windows Defender might flag first run (false positive)
            
            ### üìù Changelog
            - Initial release
            - Full feature set implemented
          files: |
            artifacts/**/*.exe
            artifacts/**/*.txt
            artifacts/**/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
