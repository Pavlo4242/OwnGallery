name: Build Media Browser Launcher

on:
  push:
  workflow_dispatch:
  #push:
  #  tags:
  #    - 'v*'

jobs:
  build-server:
    name: Build Go Server (${{ matrix.platform }})
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - goarch: amd64
            platform: windows-amd64
            output: MediaBrowser.exe
          - goarch: arm64
            platform: windows-arm64
            output: MediaBrowser-arm64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build Go server (static)
        env:
          CGO_ENABLED: 0
          GOOS: windows
          GOARCH: ${{ matrix.goarch }}
        run: |
          cd server
          go build -trimpath -ldflags="-s -w -X main.Version=${{ github.ref_name }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o server.exe .
          dir

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.platform }}
          path: server/server.exe

  build-launcher:
    name: Build Launcher (${{ matrix.platform }})
    runs-on: windows-latest
    needs: build-server
    strategy:
      matrix:
        include:
          - goarch: amd64
            platform: windows-amd64
            output: MediaBrowser.exe
          - goarch: arm64
            platform: windows-arm64
            output: MediaBrowser-arm64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Go server
        uses: actions/download-artifact@v4
        with:
          name: server-${{ matrix.platform }}
          path: server/

      - name: Verify server.exe
        run: |
          if (!(Test-Path "server/server.exe")) { exit 1 }
          Write-Host "server.exe found, size: $((Get-Item server/server.exe).Length / 1MB) MB"

      - name: Build resource file
        shell: bash
        run: |
          cd launcher
          windres resource.rc -O coff -o resource.res
          ls -lh resource.res

      - name: Build C launcher (x64/arm64)
        shell: bash   # This is the fix — no more cmd.exe "Terminate batch job?"
        run: |
          cd launcher
          echo "Building ${{ matrix.output }}..."
          gcc -O3 -s -static -mwindows \
              -o "../${{ matrix.output }}" launcher.c resource.res \
              -lshlwapi -lole32 -lshell32 -lcomdlg32 -ladvapi32 \
              -Wl,--high-entropy-va,--dynamicbase,--nxcompat,--large-address-aware
          cd ..
          ls -lh ${{ matrix.output }}

      - name: Create dist package
        run: |
          mkdir dist
          Copy-Item ${{ matrix.output }} dist/
          Copy-Item server/server.exe dist/server-embedded.exe  # optional: keep for debugging

          $readme = @"
              Media Gallery Launcher
              ======================
              
              Version: ${{ github.ref_name }}
              Build: #${{ github.run_number }} (${{ github.sha }})
              Built: $(Get-Date -Format "yyyy-MM-dd HH:mm") UTC
              
              Usage:
              1. Drop this .exe into any folder with photos/videos
              2. Double-click → gallery opens in browser at https://localhost:8443
              
              Features:
              • Single executable (no install)
              • HTTPS with auto-cert
              • Supports JPG, PNG, WebP, GIF, MP4, WebM, MOV, etc.
              • Slideshow, shuffle, keyboard navigation
              
              Note: First run may trigger Windows Defender (false positive). Add exclusion if needed.
              "@
                        $readme | Out-File -FilePath dist/README.txt -Encoding UTF8

      - name: Generate SHA256
        run: |
          cd dist
          Get-FileHash ${{ matrix.output }} -Algorithm SHA256 | 
            Select-Object -ExpandProperty Hash | 
            ForEach-Object { "$_  ${{ matrix.output }}" } > "${{ matrix.output }}.sha256"

      - name: Upload final artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: dist/*

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-launcher
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Media Browser Launcher ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/MediaBrowser*.exe
            artifacts/**/README.txt
            artifacts/**/*.sha256
          body: |
            ## Media Browser Launcher ${{ github.ref_name }}

            Single-file local media gallery viewer.

            ### Downloads
            - **Windows x64**: `MediaBrowser.exe`
            - **Windows ARM64**: `MediaBrowser-arm64.exe`

            Just drop into any folder and run!
