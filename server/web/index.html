<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Gallery</title>
    <style>
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            background-color: #0a0a0a;
            color: #e0e0e0;
        }

        .controls {
            padding: 15px;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            border-bottom: 1px solid #3a3a3a;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .controls.hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .controls-left, .controls-center, .controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .controls-center {
            flex: 1;
            justify-content: center;
        }

        .current-folder {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            padding: 8px 16px;
            border-radius: 6px;
            color: #4CAF50;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 300px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .current-folder-path {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-counter {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
            padding: 8px 16px;
            border-radius: 6px;
            color: #2196F3;
            font-weight: 500;
        }

        .nav-controls {
            display: flex;
            gap: 5px;
            margin-left: 5px;
        }

        .controls label {
            margin-right: 10px;
            color: #b0b0b0;
        }

        .controls input[type="range"] {
            width: 200px;
            vertical-align: middle;
        }

        .controls select,
        .controls button {
            padding: 8px 16px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .controls button:hover {
            background-color: #3a3a3a;
            border-color: #4a4a4a;
        }

        .controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grid {
            margin: 20px;
            min-height: 100vh;
        }

        .grid-item {
            width: 250px;
            margin-bottom: 15px;
            box-sizing: border-box;
            overflow: hidden;
            cursor: pointer;
            background-color: #1a1a1a;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .grid-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.5);
        }

        .grid-item:hover .item-info {
            opacity: 1;
        }

        .grid-item img,
        .grid-item video {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 12px;
            pointer-events: none;
            min-height: 100px; /* Prevent collapse */
            background-color: #222;
        }

        /* Folder Card Styles */
        .folder-card {
            background: #2d2d2d;
            border: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
            height: 150px;
        }
        .folder-card:hover {
            border-color: #4CAF50;
            background: #3a3a3a;
        }
        .folder-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        /* Next Folder Card */
        .next-folder-card {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            border: 1px solid #5c6bc0;
        }
        .next-folder-card:hover {
            border-color: #8e99f3;
            background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
        }

        .item-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            color: #fff;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-type {
            color: #888;
            font-size: 10px;
        }

        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.98);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .fullscreen-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .fullscreen-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .fullscreen-content img,
        .fullscreen-content video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 1002;
        }

        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) scale(1.15);
        }

        .nav-btn:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        .prev-btn { left: 30px; }
        .next-btn { right: 30px; }

        .close-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            color: #fff;
            font-size: 36px;
            cursor: pointer;
            z-index: 1002;
            background-color: rgba(0, 0, 0, 0.6);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background-color: rgba(255, 50, 50, 0.8);
            transform: rotate(90deg);
        }

        .media-info {
            position: absolute;
            bottom: 30px;
            left: 30px;
            color: white;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1002;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 400px;
        }

        .media-counter {
            font-size: 16px;
            font-weight: 600;
            color: #4CAF50;
        }

        .media-filename {
            font-size: 13px;
            color: #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .media-filetype {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }

        .playback-controls {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 20px;
            z-index: 1002;
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s ease;
        }

        .playback-controls.auto-hide {
            opacity: 0;
            pointer-events: none;
        }

        .playback-controls:hover {
            opacity: 1 !important;
            pointer-events: all !important;
        }

        .playback-controls button {
            background-color: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .playback-controls button:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        .playback-controls button.active {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 20px;
            color: #888;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .scroll-progress {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #888;
            backdrop-filter: blur(10px);
            z-index: 99;
        }
        .top-left-close {
            position: absolute;
            top: 30px;
            left: 30px;
            color: #fff;
            font-size: 36px;
            cursor: pointer;
            z-index: 1002;
            background-color: rgba(0, 0, 0, 0.6);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        .top-left-close:hover {
            background-color: rgba(255, 50, 50, 0.8);
            transform: rotate(90deg);
        }

        .bottom-right-root {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            z-index: 1002;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .bottom-right-root:hover {
            background-color: rgba(76, 175, 80, 0.8);
            border-color: #4CAF50;
        }
        /* List View Styles */
        .list-view {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #1a1a1a;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            background-color: #2a2a2a;
            transform: translateX(5px);
        }

        .list-item-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .list-item-info {
            flex: 1;
            min-width: 0;
        }

        .list-item-name {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-item-meta {
            font-size: 12px;
            color: #888;
        }

        /* Multi-select Styles */
        .grid-item-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            z-index: 10;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .multi-select-mode .grid-item-checkbox {
            opacity: 1;
        }

        .grid-item-checkbox:checked {
            opacity: 1;
        }

        .grid-item.selected {
            outline: 3px solid #ff9800;
            outline-offset: -3px;
        }

        /* Favorite Star - Bottom Right */
        .favorite-star {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 36px;
            height: 36px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-size: 18px;
            opacity: 0;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .grid-item:hover .favorite-star,
        .favorite-star.is-favorite {
            opacity: 1;
        }

        .favorite-star:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(1.15);
            border-color: #ffd700;
        }

        .favorite-star.is-favorite {
            color: #ffd700;
            background-color: rgba(255, 215, 0, 0.2);
            opacity: 1;
        }

        /* Quick Preview Overlay */
        .quick-preview-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            max-width: 70vw;
            max-height: 70vh;
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            pointer-events: none;
            backdrop-filter: blur(10px);
            display: none;
        }

        .quick-preview-overlay img,
        .quick-preview-overlay video {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
        }

        .quick-preview-info {
            margin-top: 12px;
            text-align: center;
            color: white;
            font-size: 14px;
        }

        /* Vertical Progress Bar */
        .vertical-progress-bar {
            position: fixed;
            left: 0;
            top: 0;
            width: 6px;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            transition: opacity 0.3s;
            display: none;
        }

        .vertical-progress-fill {
            width: 100%;
            background: linear-gradient(to bottom, #4CAF50, #2196F3);
            transition: height 0.1s linear;
            height: 0%;
        }

        /* View Mode Toggle Buttons */
        .view-mode-toggle {
            display: flex;
            gap: 5px;
            background-color: #2a2a2a;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid #3a3a3a;
        }

        .view-mode-btn {
            padding: 6px 12px;
            background-color: transparent;
            color: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .view-mode-btn.active {
            background-color: #2196F3;
        }

        .view-mode-btn:hover:not(.active) {
            background-color: #3a3a3a;
        }

        /* Navigation FAB Buttons */
        .nav-fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 98;
        }

        .nav-fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: rgba(33, 150, 243, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .nav-fab:hover {
            background-color: rgba(33, 150, 243, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }

        /* Delete button styling */
        .delete-btn {
            background-color: rgba(244, 67, 54, 0.2) !important;
            border: 1px solid #f44336 !important;
            color: #f44336 !important;
        }

        .delete-btn:hover {
            background-color: rgba(244, 67, 54, 0.3) !important;
        }

        /* Directory Displays */
        .fullscreen-dir {
            position: absolute;
            top: 100px;
            left: 30px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            z-index: 1002;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 6px 12px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            pointer-events: none;
        }

        .gallery-dir {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 16px;
            font-weight: 500;
            z-index: 99;
            transition: all 0.3s ease;
            cursor: default;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            background-color: rgba(0,0,0,0.2);
            padding: 8px 16px;
            border-radius: 8px;
            backdrop-filter: blur(2px);
        }

        .gallery-dir:hover {
            color: #fff;
            background-color: rgba(0,0,0,0.6);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
<div class="controls" id="topControls">
    <div class="controls-left">
        <button onclick="openExplorerAndShowPath()" class="current-folder" id="currentFolder" title="Click to open folder in explorer">
            <span>üìÅ</span>
            <span id="folderName" class="current-folder-path">Loading Root Path...</span>
        </button>
        <div class="file-counter" id="fileCounter">0 files</div>
        <div class="nav-controls">
            <button onclick="navigateBack()" id="navBackBtn" title="Go Back">‚Üê</button>
            <button onclick="navigateRoot()" id="navRootBtn" title="Return to Root">‚ñ†</button>
            <button onclick="navigateForward()" id="navForwardBtn" title="Go Forward">‚Üí</button>
        </div>
    </div>
    
    <div class="controls-center">
        <div class="view-mode-toggle">
            <button class="view-mode-btn active" id="gridViewBtn" onclick="setViewMode('grid')" title="Grid View">
                ‚ñ¶
            </button>
            <button class="view-mode-btn" id="listViewBtn" onclick="setViewMode('list')" title="List View">
                ‚ò∞
            </button>
        </div>
        
        <button onclick="initializeGallery()">üîÑ Reload</button>
        
        <label>
            <input type="checkbox" id="quickPreviewToggle" onchange="toggleQuickPreview()"> Quick Preview
        </label>
        
        <label>
            <input type="checkbox" id="multiSelectToggle" onchange="toggleMultiSelect()"> Multi-Select
        </label>
        
        <button onclick="deleteSelected()" id="deleteBtn" style="display:none;" class="delete-btn">
            üóëÔ∏è Delete (<span id="selectedCount">0</span>)
        </button>
        
        <label for="thumbnailWidth">Size:</label>
        <input type="range" id="thumbnailWidth" min="150" max="400" value="250" onchange="updateThumbnailSize()">
        
        <label for="folderFilter">Folder:</label>
        <select id="folderFilter" onchange="filterGalleryByFolder()">
            <option value="all">All Files</option>
        </select>
        
        <button onclick="filterFavorites()">‚≠ê Favorites</button>
        
        <label>
            <input type="checkbox" id="shuffleToggle" onchange="saveSettings()"> Shuffle
        </label>
        <button onclick="forceReshuffle()">üîÄ Re-shuffle</button>
        <button onclick="resetViewed()">‚Ü∫ Reset Viewed</button>
    </div>
    
    <div class="controls-right">
    </div>
</div>

<div class="grid"></div>

<div id="galleryDir" class="gallery-dir"></div>

<div class="scroll-progress" id="scrollProgress">
    Loaded: <span id="loadedCount">0</span> / <span id="totalCount">0</span>
</div>

<div id="fullscreenOverlay" class="fullscreen-overlay">
    <span class="top-left-close" onclick="closeFullscreen()">&times;</span>
    
    <div id="fullscreenDir" class="fullscreen-dir"></div>
    
    <span class="close-btn" onclick="closeFullscreen()">&times;</span>
    <button class="nav-btn prev-btn" id="prevBtn">‚Äπ</button>
    <button class="nav-btn next-btn" id="nextBtn">‚Ä∫</button>
    <div class="fullscreen-content"></div>
    <div class="media-info" id="mediaInfo">
        <div class="media-counter"></div>
        <div class="media-filename"></div>
        <div class="media-filetype"></div>
    </div>
    <div class="playback-controls" id="playbackControls">
        <button id="playPauseBtn">‚ñ∂ Play</button>
        <button id="toggleShuffleBtn" onclick="toggleShuffleInSlideshow()">üîÄ Shuffle: OFF</button>
        <button id="sequentialModeBtn" onclick="toggleSequentialMode()">
            üìã <span id="modeText">Sequential</span>
        </button>
        <div style="text-align: center;">
            <label style="color: white; font-size: 11px;">Speed (ms)</label>
            <input type="number" id="advanceTime" min="500" max="30000" step="100" value="3000" 
                   style="width: 100px; padding: 8px; border-radius: 8px; border: none; text-align: center; margin-top: 5px;"
                   onchange="saveSettings()">
        </div>
        <button onclick="closeFullscreen()">‚Ü© Back to Gallery</button>
        <button onclick="scrollToTop()">‚Üë Back to Top</button>
    </div>
    <button class="bottom-right-root" onclick="returnToRootFromFullscreen()">‚ñ† Return to Root</button>
    
    <div id="verticalProgress" class="vertical-progress-bar">
        <div class="vertical-progress-fill" id="progressFill"></div>
    </div>
</div>

<div class="nav-fab-container" id="navFabs">
    <div class="nav-fab" onclick="scrollToTop()" title="Back to Top">‚åÇ</div>
    <div class="nav-fab" onclick="scrollByAmount(800)" title="Scroll Down">‚Üì</div>
    <div class="nav-fab" onclick="scrollByAmount(2400)" title="Scroll Fast">‚áü</div>
</div>

<script src="masonry.pkgd.min.js"></script>
<script src="imagesloaded.pkgd.min.js"></script>

<script>
    let allMediaFiles = [];
    let MEDIA_DATA = {};
    let FOLDER_MAP = {};
    let allDirectories = [];
    let masonry;
    let loadedMediaCount = 0;
    const filesPerLoad = 30;
    let currentMediaIndex = -1;
    let autoAdvanceInterval = null;
    let isPlaying = false;
    let viewedFiles = new Set();
    let controlsHideTimer = null;
    let currentRootPath = 'Loading...';
    let globalVolume = 1.0;
    let slideshowShuffle = false;
    let viewMode = 'grid';
    let multiSelectMode = false;
    let selectedFiles = new Set();
    let favoriteFiles = new Set();
    let quickPreviewEnabled = false;
    let quickPreviewTimeout = null;
    let sequentialMode = true;
    let videoPlayLimit = 5;
    let animObserver = null;

    // Navigation History Variables
    let navigationHistory = [];
    let historyIndex = -1;

    // --- Initialization ---
    function updateSequentialModeUI() {
        const btn = document.getElementById('sequentialModeBtn');
        const modeText = document.getElementById('modeText');
        if (btn && modeText) {
            modeText.textContent = sequentialMode ? 'Sequential' : 'Random';
            if (sequentialMode) {
                btn.classList.remove('active');
            } else {
                btn.classList.add('active');
            }
        }
    }

    function loadFavorites() {
        const saved = localStorage.getItem('favoriteFiles');
        if (saved) {
            favoriteFiles = new Set(JSON.parse(saved));
        }
    }

    function saveFavorites() {
        localStorage.setItem('favoriteFiles', JSON.stringify(Array.from(favoriteFiles)));
    }

    function saveSettings() {
        const settings = {
            thumbWidth: document.getElementById('thumbnailWidth').value,
            shuffle: document.getElementById('shuffleToggle').checked,
            speed: document.getElementById('advanceTime').value,
            slideshowShuffle: slideshowShuffle,
            quickPreview: document.getElementById('quickPreviewToggle').checked,
            viewMode: viewMode,
            sequentialMode: sequentialMode
        };
        localStorage.setItem('gallerySettings', JSON.stringify(settings));
    }

    function loadSettings() {
        const saved = JSON.parse(localStorage.getItem('gallerySettings'));
        if (saved) {
            if (saved.thumbWidth) document.getElementById('thumbnailWidth').value = saved.thumbWidth;
            if (saved.shuffle) document.getElementById('shuffleToggle').checked = saved.shuffle;
            if (saved.speed) document.getElementById('advanceTime').value = saved.speed;
            if (saved.slideshowShuffle !== undefined) {
                slideshowShuffle = saved.slideshowShuffle;
                updateShuffleButtonText();
            }
            if (saved.quickPreview !== undefined) {
                quickPreviewEnabled = saved.quickPreview;
                document.getElementById('quickPreviewToggle').checked = saved.quickPreview;
            }
            if (saved.viewMode) {
                viewMode = saved.viewMode;
            }
            if (saved.sequentialMode !== undefined) {
                sequentialMode = saved.sequentialMode;
            }
        }
        loadFavorites();
    }

    // --- View Modes ---
    function setViewMode(mode) {
        viewMode = mode;
        document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
        document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
        saveSettings();
        refreshGalleryView();
    }

    function refreshGalleryView() {
        const grid = document.querySelector('.grid');
        if (viewMode === 'list') {
            grid.classList.add('list-view');
            grid.classList.remove('masonry-grid');
            if (masonry) {
                masonry.destroy();
                masonry = null;
            }
        } else {
            grid.classList.remove('list-view');
            grid.classList.add('masonry-grid');
        }
        filterGalleryByFolder(false);
    }

    // --- Multi-Select ---
    function toggleMultiSelect() {
        multiSelectMode = document.getElementById('multiSelectToggle').checked;
        const grid = document.querySelector('.grid');
        if (multiSelectMode) {
            grid.classList.add('multi-select-mode');
        } else {
            grid.classList.remove('multi-select-mode');
            selectedFiles.clear();
        }
        updateSelectedCount();
    }

    function toggleFileSelection(fileName, checkbox) {
        const gridItem = checkbox.closest('.grid-item');
        if (checkbox.checked) {
            selectedFiles.add(fileName);
            if (gridItem) gridItem.classList.add('selected');
        } else {
            selectedFiles.delete(fileName);
            if (gridItem) gridItem.classList.remove('selected');
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = selectedFiles.size;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('deleteBtn').style.display = count > 0 ? 'inline-block' : 'none';
    }

    function deleteSelected() {
        if (selectedFiles.size === 0) return;
        const confirmed = confirm(`Are you sure you want to delete ${selectedFiles.size} file(s)?\n\nThis action cannot be undone!`);
        if (!confirmed) return;
        
        const deletePromises = Array.from(selectedFiles).map(fileName => {
            return fetch('/api/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: fileName })
            });
        });
        
        Promise.all(deletePromises)
            .then(() => {
                alert(`Deleted ${selectedFiles.size} file(s)`);
                selectedFiles.clear();
                initializeGallery();
            })
            .catch(err => {
                alert('Error deleting files: ' + err.message);
            });
    }

    // --- Favorites ---
    function toggleFavorite(fileName, event) {
        event.stopPropagation();
        if (favoriteFiles.has(fileName)) {
            favoriteFiles.delete(fileName);
        } else {
            favoriteFiles.add(fileName);
        }
        saveFavorites();
        const star = event.currentTarget;
        star.classList.toggle('is-favorite');
        star.textContent = favoriteFiles.has(fileName) ? '‚òÖ' : '‚òÜ';
    }

    function filterFavorites() {
        const select = document.getElementById('folderFilter');
        select.value = 'all'; // Reset folder to all when showing favorites
        
        allMediaFiles = Array.from(favoriteFiles).filter(f => MEDIA_DATA[f]);
        loadedMediaCount = 0;
        const grid = document.querySelector('.grid');
        if (masonry) {
            masonry.destroy();
            masonry = null;
        }
        grid.innerHTML = '';
        updateFileCounter();
        loadMoreMedia();
    }

    // --- Quick Preview ---
    function showQuickPreview(fileName) {
        if (!quickPreviewEnabled) return;
        clearTimeout(quickPreviewTimeout);
        quickPreviewTimeout = setTimeout(() => {
            const mediaInfo = MEDIA_DATA[fileName];
            if (!mediaInfo) return;
            
            let overlay = document.getElementById('quickPreviewOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'quickPreviewOverlay';
                overlay.className = 'quick-preview-overlay';
                document.body.appendChild(overlay);
            }
            
            const mediaEl = mediaInfo.isVideo 
                ? `<video src="${mediaInfo.url}" autoplay muted loop style="max-width: 100%; max-height: 60vh;"></video>`
                : `<img src="${mediaInfo.url}" style="max-width: 100%; max-height: 60vh;">`;
            
            overlay.innerHTML = `
                ${mediaEl}
                <div class="quick-preview-info">
                    <strong>${mediaInfo.name}</strong><br>
                    <span style="color: #888;">${getFileExtension(mediaInfo.name)}</span>
                </div>
            `;
            overlay.style.display = 'block';
        }, 300);
    }

    function hideQuickPreview() {
        clearTimeout(quickPreviewTimeout);
        const overlay = document.getElementById('quickPreviewOverlay');
        if (overlay) {
            overlay.style.display = 'none';
            overlay.innerHTML = '';
        }
    }

    // --- Playback Management (Videos & WebP) ---
    function manageVideoPlayback() {
        const videos = Array.from(document.querySelectorAll('.grid video'));
        const visibleVideos = videos.filter(video => {
            const rect = video.getBoundingClientRect();
            return rect.top < window.innerHeight && rect.bottom > 0;
        });
        
        videos.forEach(v => {
            if (!visibleVideos.includes(v)) {
                v.pause();
                v.currentTime = 0;
            }
        });
        
        const toPlay = visibleVideos.slice(0, videoPlayLimit);
        toPlay.forEach(v => {
            if (v.paused) {
                v.play().catch(() => {});
            }
        });
        
        visibleVideos.slice(videoPlayLimit).forEach(v => {
            v.pause();
            v.currentTime = 0;
        });
    }

    function initAnimObserver() {
        if (animObserver) return;
        
        animObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const img = entry.target;
                if (entry.isIntersecting) {
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                    }
                } else {
                    // Unload WebP to stop background animation
                    if (img.src && img.dataset.src) {
                        // Store height to prevent layout collapse
                        img.style.height = img.offsetHeight + 'px'; 
                        img.src = ''; 
                    }
                }
            });
        }, { rootMargin: '200px' });
    }

    // --- General UI Actions ---
    function openExplorerAndShowPath() {
        openExplorer();
    }

    function toggleQuickPreview() {
        quickPreviewEnabled = document.getElementById('quickPreviewToggle').checked;
        saveSettings();
        if (!quickPreviewEnabled) hideQuickPreview();
    }

    function updateThumbnailSize() {
        const newWidth = parseInt(document.getElementById('thumbnailWidth').value);
        document.querySelectorAll('.grid-item').forEach(item => {
            item.style.width = `${newWidth}px`;
        });
        if (masonry) {
            masonry.options.columnWidth = newWidth;
            masonry.layout();
        }
        saveSettings();
    }

    function scrollByAmount(amount) {
        window.scrollBy({ top: amount, behavior: 'smooth' });
    }

    let lastScrollY = 0;
    let scrollTimeout = null;
    let controlsVisible = true;
    let videoScrollTimeout;

    function handleScroll() {
        const controls = document.getElementById('topControls');
        const currentScrollY = window.scrollY;
        
        clearTimeout(scrollTimeout);
        
        if (currentScrollY > lastScrollY && currentScrollY > 100) {
            controls.classList.add('hidden');
            controlsVisible = false;
        }
        
        lastScrollY = currentScrollY;
        
        scrollTimeout = setTimeout(() => {
            if (!controlsVisible) {
                controls.classList.remove('hidden');
                controlsVisible = true;
            }
        }, 1500);
        
        manageVideoPlayback();
        
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 500) &&
            loadedMediaCount < allMediaFiles.length) {
            loadMoreMedia();
        }
    }

    window.addEventListener('scroll', () => {
        clearTimeout(videoScrollTimeout);
        videoScrollTimeout = setTimeout(handleScroll, 100);
    });

    document.addEventListener('mousemove', (e) => {
        if (e.clientY < 100) {
            document.getElementById('topControls').classList.remove('hidden');
            controlsVisible = true;
        }
    });

    function updateFileCounter() {
        const total = allMediaFiles.length;
        const loaded = Math.min(loadedMediaCount, total);
        document.getElementById('fileCounter').textContent = `${total} files`;
        document.getElementById('loadedCount').textContent = loaded;
        document.getElementById('totalCount').textContent = total;
    }

    async function updateRootPathDisplay() {
        try {
            const response = await fetch('/api/root_dir');
            if (response.ok) {
                const data = await response.json();
                currentRootPath = data.root_dir;
                document.getElementById('folderName').textContent = currentRootPath;
                document.getElementById('currentFolder').title = 'Current Root: ' + currentRootPath;
            } else {
                document.getElementById('folderName').textContent = 'Root Path Error';
            }
        } catch (e) {
            console.error("Failed to fetch root directory:", e);
            document.getElementById('folderName').textContent = 'API Error';
        }
    }
    
    async function openExplorer() {
        try {
            const response = await fetch('/api/open_explorer');
            if (!response.ok) alert('Failed to open folder.');
        } catch (e) {
            alert('Connection error.');
        }
    }

    // --- Main Logic ---
    async function initializeGallery() {
        const grid = document.querySelector('.grid');
        grid.innerHTML = '<div class="loading">Loading media files</div>';
        
        loadSettings();
        initAnimObserver();
        
        navigationHistory = [];
        historyIndex = -1;
        updateNavigationButtons();

        await updateRootPathDisplay();
        
        document.getElementById('gridViewBtn').classList.toggle('active', viewMode === 'grid');
        document.getElementById('listViewBtn').classList.toggle('active', viewMode === 'list');
        
        try {
            const response = await fetch('/api/files');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const apiData = await response.json();
            const fileList = apiData.files || [];
            allDirectories = apiData.directories || [];

            if (fileList.length === 0 && allDirectories.length === 0) {
                grid.innerHTML = '<div class="loading">No media files or folders found</div>';
                return;
            }
            
            FOLDER_MAP = { 'all': [] };
            MEDIA_DATA = {};
            
            allDirectories.forEach(folderName => {
                if (!FOLDER_MAP[folderName]) FOLDER_MAP[folderName] = [];
            });
            
            fileList.forEach((fileInfo) => {
                const relativePath = fileInfo.path;
                const webUrl = '/media/' + relativePath.split('/').map(encodeURIComponent).join('/');
                
                MEDIA_DATA[relativePath] = {
                    url: webUrl,
                    name: fileInfo.name,
                    isVideo: fileInfo.isVideo
                };
                FOLDER_MAP['all'].push(relativePath);
                
                const parts = relativePath.split('/');
                if (parts.length > 1) {
                    const folderName = parts.slice(0, -1).join('/');
                    if (!FOLDER_MAP[folderName]) FOLDER_MAP[folderName] = [];
                    FOLDER_MAP[folderName].push(relativePath);
                }
            });
            
            populateFolderFilter();
            filterGalleryByFolder(true);
            
        } catch (error) {
            console.error('Error:', error);
            grid.innerHTML = `<div class="loading">Error: ${error.message}</div>`;
        }
    }
        
    function populateFolderFilter() {
        const select = document.getElementById('folderFilter');
        select.innerHTML = '<option value="all">All Files</option>';
        
        Object.keys(FOLDER_MAP).sort().forEach(folderName => {
            if (folderName === 'all') return;
            const option = document.createElement('option');
            option.value = folderName;
            const depth = (folderName.match(/\//g) || []).length;
            option.textContent = '  '.repeat(depth) + folderName + ` (${FOLDER_MAP[folderName].length})`;
            select.appendChild(option);
        });
    }

    function updateNavigationButtons() {
        document.getElementById('navBackBtn').disabled = historyIndex <= 0;
        document.getElementById('navForwardBtn').disabled = historyIndex >= navigationHistory.length - 1;
    }

    function navigateBack() {
        if (historyIndex > 0) {
            historyIndex--;
            const folder = navigationHistory[historyIndex];
            document.getElementById('folderFilter').value = folder;
            filterGalleryByFolder(false);
        }
    }

    function navigateForward() {
        if (historyIndex < navigationHistory.length - 1) {
            historyIndex++;
            const folder = navigationHistory[historyIndex];
            document.getElementById('folderFilter').value = folder;
            filterGalleryByFolder(false);
        }
    }

    function navigateRoot() {
        document.getElementById('folderFilter').value = 'all';
        filterGalleryByFolder(true);
    }

    function filterGalleryByFolder(recordHistory = true) {
        const select = document.getElementById('folderFilter');
        const folderName = select.value;
        const grid = document.querySelector('.grid');
        const shuffleEnabled = document.getElementById('shuffleToggle').checked;
        const thumbnailWidth = document.getElementById('thumbnailWidth').value;
        
        // Update Gallery Directory Display
        const galleryDir = document.getElementById('galleryDir');
        galleryDir.textContent = folderName === 'all' ? 'Root' : folderName;
        
        if (recordHistory) {
            if (historyIndex === -1 || navigationHistory[historyIndex] !== folderName) {
                navigationHistory = navigationHistory.slice(0, historyIndex + 1);
                navigationHistory.push(folderName);
                historyIndex++;
            }
        }
        updateNavigationButtons();

        if (masonry) {
            masonry.destroy();
            masonry = null;
        }

        grid.innerHTML = '';
        
        // --- Folder Navigation Cards ---
        const currentPrefix = folderName === 'all' ? '' : folderName + '/';
        const subfolders = allDirectories.filter(dir => {
            if (folderName === 'all') return !dir.includes('/'); 
            return dir.startsWith(currentPrefix) && 
                   dir.slice(currentPrefix.length).indexOf('/') === -1 &&
                   dir !== folderName;
        });

        if (subfolders.length > 0) {
            const folderElements = subfolders.map(subDir => {
                const card = document.createElement('div');
                card.className = 'grid-item folder-card';
                card.style.width = `${thumbnailWidth}px`;
                
                const displayName = subDir.split('/').pop();
                card.innerHTML = `
                    <div class="folder-icon">üìÅ</div>
                    <div class="item-name">${displayName}</div>
                `;
                card.onclick = () => {
                    select.value = subDir;
                    filterGalleryByFolder(true);
                };
                return card;
            });
            grid.append(...folderElements);
        }

        // --- Recursive File Gathering ---
        let displayList;
        if (folderName === 'all') {
            displayList = [...FOLDER_MAP['all']];
        } else {
            // Show all files that start with folderName + '/' to include subdirectories recursively
            displayList = FOLDER_MAP['all'].filter(f => f.startsWith(folderName + '/'));
        }
        
        if (shuffleEnabled) {
            shuffleArray(displayList);
        }
        
        allMediaFiles = displayList;
        loadedMediaCount = 0;
        updateFileCounter();
        loadMoreMedia();
        saveSettings();
    }

    function shuffleArray(array) {
        const unviewed = array.filter(file => !viewedFiles.has(file));
        const viewed = array.filter(file => viewedFiles.has(file));
        
        for (let i = unviewed.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [unviewed[i], unviewed[j]] = [unviewed[j], unviewed[i]];
        }
        
        for (let i = viewed.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [viewed[i], viewed[j]] = [viewed[j], viewed[i]];
        }
        
        array.length = 0;
        array.push(...unviewed, ...viewed);
    }

    function forceReshuffle() {
        filterGalleryByFolder(false);
    }

    function resetViewed() {
        viewedFiles.clear();
        filterGalleryByFolder(false);
    }

    function scrollToTop() {
        const overlay = document.getElementById('fullscreenOverlay');
        if (overlay.classList.contains('visible')) closeFullscreen();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function toggleShuffleInSlideshow() {
        slideshowShuffle = !slideshowShuffle;
        updateShuffleButtonText();
        saveSettings();
    }

    function updateShuffleButtonText() {
        const btn = document.getElementById('toggleShuffleBtn');
        if (btn) {
            btn.textContent = slideshowShuffle ? 'üîÄ Shuffle: ON' : 'üîÄ Shuffle: OFF';
            btn.classList.toggle('active', slideshowShuffle);
        }
    }

    function returnToRootFromFullscreen() {
        closeFullscreen();
        navigateRoot();
    }

    function getFileExtension(fileName) {
        const parts = fileName.split('.');
        return parts.length > 1 ? parts[parts.length - 1].toUpperCase() : 'FILE';
    }

    function createMediaElement(fileName) {
        const mediaInfo = MEDIA_DATA[fileName];
        const isVideo = mediaInfo.isVideo;
        let mediaElement;

        if (isVideo) {
            mediaElement = document.createElement('video');
            mediaElement.autoplay = false;
            mediaElement.muted = true;
            mediaElement.loop = true;
            mediaElement.preload = 'metadata';
            mediaElement.src = mediaInfo.url;
        } else {
            mediaElement = document.createElement('img');
            mediaElement.loading = 'lazy';
            
            if (fileName.toLowerCase().endsWith('.webp')) {
                // WebP Optimization: Use data-src and observe
                mediaElement.dataset.src = mediaInfo.url;
                mediaElement.classList.add('lazy-anim');
                if (animObserver) animObserver.observe(mediaElement);
            } else {
                mediaElement.src = mediaInfo.url;
            }
        }
        return mediaElement;
    }

    function initializeMasonry() {
        const grid = document.querySelector('.grid');
        if (masonry) masonry.destroy();
        
        masonry = new Masonry(grid, {
            itemSelector: '.grid-item',
            columnWidth: parseInt(document.getElementById('thumbnailWidth').value),
            gutter: 15,
            fitWidth: true
        });
    }

    function appendMediaToGrid(files) {
        const grid = document.querySelector('.grid');
        if (files.length === 0) {
            if (!masonry && grid.children.length > 0 && viewMode === 'grid') initializeMasonry();
            return;
        }
        
        const thumbnailWidth = document.getElementById('thumbnailWidth').value;

        const elements = files.map((fileName) => {
            const mediaInfo = MEDIA_DATA[fileName];
            const isFavorite = favoriteFiles.has(fileName);
            
            if (viewMode === 'list') {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.onclick = () => openFullscreen(fileName);
                
                const thumbnail = createMediaElement(fileName);
                thumbnail.className = 'list-item-thumbnail';
                
                const checkbox = multiSelectMode ? `<input type="checkbox" class="grid-item-checkbox" onchange="toggleFileSelection('${fileName.replace(/'/g, "\\'")}', this)">` : '';
                
                listItem.innerHTML = `
                    ${checkbox}
                    <div class="list-item-info">
                        <div class="list-item-name">${mediaInfo.name}</div>
                        <div class="list-item-meta">${getFileExtension(mediaInfo.name)} ‚Ä¢ ${mediaInfo.isVideo ? 'Video' : 'Image'}</div>
                    </div>
                `;
                
                const starBtn = document.createElement('div');
                starBtn.className = `favorite-star ${isFavorite ? 'is-favorite' : ''}`;
                starBtn.textContent = isFavorite ? '‚òÖ' : '‚òÜ';
                starBtn.onclick = (e) => toggleFavorite(fileName, e);
                listItem.appendChild(starBtn);
                
                listItem.insertBefore(thumbnail, listItem.children[multiSelectMode ? 1 : 0]);
                return listItem;
            } else {
                const gridItem = document.createElement('div');
                gridItem.classList.add('grid-item');
                gridItem.style.width = `${thumbnailWidth}px`;
                
                if (selectedFiles.has(fileName)) gridItem.classList.add('selected');
                
                if (multiSelectMode) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'grid-item-checkbox';
                    checkbox.checked = selectedFiles.has(fileName);
                    checkbox.onclick = (e) => {
                        e.stopPropagation();
                        toggleFileSelection(fileName, e.target);
                    };
                    gridItem.appendChild(checkbox);
                }
                
                const star = document.createElement('div');
                star.className = `favorite-star ${isFavorite ? 'is-favorite' : ''}`;
                star.textContent = isFavorite ? '‚òÖ' : '‚òÜ';
                star.onclick = (e) => toggleFavorite(fileName, e);
                gridItem.appendChild(star);
                
                const mediaEl = createMediaElement(fileName);
                gridItem.appendChild(mediaEl);
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'item-info';
                infoDiv.innerHTML = `
                    <div class="item-name" title="${mediaInfo.name}">${mediaInfo.name}</div>
                    <div class="item-type">${getFileExtension(mediaInfo.name)} ‚Ä¢ ${mediaInfo.isVideo ? 'Video' : 'Image'}</div>
                `;
                gridItem.appendChild(infoDiv);
                
                gridItem.addEventListener('click', (e) => {
                    if (multiSelectMode) {
                        const checkbox = gridItem.querySelector('.grid-item-checkbox');
                        if (checkbox && e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                            toggleFileSelection(fileName, checkbox);
                        }
                    } else {
                        openFullscreen(fileName);
                    }
                });
                
                gridItem.addEventListener('mouseenter', () => showQuickPreview(fileName));
                gridItem.addEventListener('mouseleave', hideQuickPreview);
                
                return gridItem;
            }
        });

        grid.append(...elements);

        if (viewMode === 'grid') {
            if (masonry) {
                masonry.appended(elements);
                imagesLoaded(elements, () => {
                    masonry.layout();
                    setTimeout(manageVideoPlayback, 200);
                });
            } else {
                imagesLoaded(elements, () => {
                    if (!masonry) {
                        initializeMasonry();
                        setTimeout(() => {
                            if (masonry) masonry.layout();
                            manageVideoPlayback();
                        }, 50);
                    }
                });
            }
        }
        
        setTimeout(manageVideoPlayback, 500);
        updateFileCounter();
    }

    function loadMoreMedia() {
        const nextBatch = allMediaFiles.slice(loadedMediaCount, loadedMediaCount + filesPerLoad);
        if (nextBatch.length > 0) {
            appendMediaToGrid(nextBatch);
            loadedMediaCount += nextBatch.length;
        } else {
            // Check if we need to add "Next Folder" button
            const currentFolder = document.getElementById('folderFilter').value;
            if (currentFolder !== 'all' && !document.getElementById('nextFolderCard')) {
                addNextFolderCard(currentFolder);
            }
        }
    }

    function addNextFolderCard(currentFolder) {
        const sortedFolders = Object.keys(FOLDER_MAP).filter(k => k !== 'all').sort();
        const currentIndex = sortedFolders.indexOf(currentFolder);
        
        if (currentIndex !== -1 && currentIndex < sortedFolders.length - 1) {
            const nextFolder = sortedFolders[currentIndex + 1];
            const grid = document.querySelector('.grid');
            const thumbnailWidth = document.getElementById('thumbnailWidth').value;
            
            const card = document.createElement('div');
            card.id = 'nextFolderCard';
            card.className = 'grid-item folder-card next-folder-card';
            card.style.width = `${thumbnailWidth}px`;
            card.innerHTML = `
                <div class="folder-icon">‚û°Ô∏è</div>
                <div class="item-name">Next: ${nextFolder.split('/').pop()}</div>
            `;
            
            card.onclick = () => {
                document.getElementById('folderFilter').value = nextFolder;
                filterGalleryByFolder(true);
                scrollToTop();
            };
            
            grid.appendChild(card);
            if (masonry) masonry.appended([card]);
        }
    }

    function openFullscreen(fileName) {
        const overlay = document.getElementById('fullscreenOverlay');
        const content = document.querySelector('.fullscreen-content');
        
        currentMediaIndex = allMediaFiles.indexOf(fileName);
        if (currentMediaIndex === -1) return;
        
        viewedFiles.add(fileName);
        
        const mediaInfo = MEDIA_DATA[fileName];
        const isVideo = mediaInfo.isVideo;
        content.innerHTML = '';

        let mediaElement;
        if (isVideo) {
            mediaElement = document.createElement('video');
            mediaElement.controls = true; 
            mediaElement.autoplay = true;
            mediaElement.loop = true;
            mediaElement.volume = globalVolume; 
            mediaElement.onvolumechange = (e) => globalVolume = e.target.volume;
        } else {
            mediaElement = document.createElement('img');
        }

        mediaElement.src = mediaInfo.url;
        content.appendChild(mediaElement);
        updateProgressBar();

        updateFullscreenInfo(fileName);
        
        // Update Fullscreen Directory Display
        const dirParts = fileName.split('/');
        const dirPath = dirParts.length > 1 ? dirParts.slice(0, -1).join('/') : 'Root';
        document.getElementById('fullscreenDir').textContent = dirPath;

        updateShuffleButtonText();
        overlay.classList.add('visible');
        resetControlsTimer();
    }

    function updateFullscreenInfo(fileName) {
        const mediaInfo = MEDIA_DATA[fileName];
        const infoDiv = document.getElementById('mediaInfo');
        
        infoDiv.querySelector('.media-counter').textContent = `${currentMediaIndex + 1} / ${allMediaFiles.length}`;
        infoDiv.querySelector('.media-filename').textContent = mediaInfo.name;
        infoDiv.querySelector('.media-filetype').textContent = `${getFileExtension(mediaInfo.name)} ‚Ä¢ ${mediaInfo.isVideo ? 'Video' : 'Image'}`;
        
        document.getElementById('prevBtn').disabled = currentMediaIndex <= 0;
        document.getElementById('nextBtn').disabled = currentMediaIndex >= allMediaFiles.length - 1;
    }

    function toggleSequentialMode() {
        sequentialMode = !sequentialMode;
        document.getElementById('modeText').textContent = sequentialMode ? 'Sequential' : 'Random';
        document.getElementById('sequentialModeBtn').classList.toggle('active');
        saveSettings();
    }

    function navigateFullscreen(direction) {
        let newIndex;
        
        if (!sequentialMode && direction > 0) {
            const unviewed = allMediaFiles.filter((file, idx) => idx !== currentMediaIndex && !viewedFiles.has(file));
            if (unviewed.length > 0) {
                const randomFile = unviewed[Math.floor(Math.random() * unviewed.length)];
                newIndex = allMediaFiles.indexOf(randomFile);
            } else {
                const others = allMediaFiles.filter((_, idx) => idx !== currentMediaIndex);
                const randomFile = others[Math.floor(Math.random() * others.length)];
                newIndex = allMediaFiles.indexOf(randomFile);
            }
        } else {
            newIndex = currentMediaIndex + direction;
        }
        
        if (newIndex >= 0 && newIndex < allMediaFiles.length) {
            currentMediaIndex = newIndex;
            openFullscreen(allMediaFiles[currentMediaIndex]);
        } else if (newIndex >= allMediaFiles.length) {
            stopAutoAdvance();
        }
    }

    function updateProgressBar() {
        const progressBar = document.getElementById('verticalProgress');
        const progressFill = document.getElementById('progressFill');
        
        if (!isPlaying) {
            progressBar.style.display = 'none';
            return;
        }
        
        progressBar.style.display = 'block';
        const progressPercent = ((currentMediaIndex + 1) / allMediaFiles.length) * 100;
        progressFill.style.height = progressPercent + '%';
    }

    function closeFullscreen() {
        document.getElementById('fullscreenOverlay').classList.remove('visible');
        stopAutoAdvance();
        currentMediaIndex = -1;
        const content = document.querySelector('.fullscreen-content');
        content.innerHTML = ''; 
    }

    function resetControlsTimer() {
        const controls = document.getElementById('playbackControls');
        controls.classList.remove('auto-hide');
        clearTimeout(controlsHideTimer);
        controlsHideTimer = setTimeout(() => {
            if (isPlaying) controls.classList.add('auto-hide');
        }, 3000);
    }

    function startAutoAdvance() {
        stopAutoAdvance();
        let delay = parseInt(document.getElementById('advanceTime').value);
        if (isNaN(delay) || delay < 500) {
            delay = 500;
            document.getElementById('advanceTime').value = 500;
        }

        autoAdvanceInterval = setInterval(() => {
            if (currentMediaIndex < allMediaFiles.length - 1) {
                navigateFullscreen(1);
                updateProgressBar();
            } else {
                stopAutoAdvance();
            }
        }, delay);
        isPlaying = true;
        document.getElementById('playPauseBtn').textContent = '‚è∏ Pause';
        document.getElementById('playPauseBtn').classList.add('active');
        updateProgressBar();
    }

    function stopAutoAdvance() {
        if (autoAdvanceInterval) {
            clearInterval(autoAdvanceInterval);
            autoAdvanceInterval = null;
        }
        isPlaying = false;
        document.getElementById('playPauseBtn').textContent = '‚ñ∂ Play';
        document.getElementById('playPauseBtn').classList.remove('active');
        document.getElementById('verticalProgress').style.display = 'none';
    }

    // --- Listeners ---
    document.getElementById('thumbnailWidth').addEventListener('input', (e) => {
        const newWidth = parseInt(e.target.value);
        document.querySelectorAll('.grid-item').forEach(item => {
            item.style.width = `${newWidth}px`;
        });
        if (masonry) {
            masonry.options.columnWidth = newWidth;
            masonry.layout();
        }
    });

    document.querySelector('.close-btn').addEventListener('click', closeFullscreen);
    document.getElementById('prevBtn').addEventListener('click', () => navigateFullscreen(-1));
    document.getElementById('nextBtn').addEventListener('click', () => navigateFullscreen(1));
    document.getElementById('playPauseBtn').addEventListener('click', () => {
        isPlaying ? stopAutoAdvance() : startAutoAdvance();
    });

    document.addEventListener('keydown', (e) => {
        const overlay = document.getElementById('fullscreenOverlay');
        if (!overlay.classList.contains('visible')) return;
        
        if (e.key === 'ArrowRight' || e.key === 'd') navigateFullscreen(1);
        else if (e.key === 'ArrowLeft' || e.key === 'a') navigateFullscreen(-1);
        else if (e.key === 'Escape') closeFullscreen();
        else if (e.key === ' ') {
            e.preventDefault();
            isPlaying ? stopAutoAdvance() : startAutoAdvance();
        }
    });

    document.getElementById('fullscreenOverlay').addEventListener('mousedown', (e) => {
        if (e.button === 1) {
            e.preventDefault();
            closeFullscreen();
            return;
        }
        if (e.target.closest('.close-btn, .playback-controls, .nav-btn, .bottom-right-root, .top-left-close')) return;
        if (e.target.tagName === 'VIDEO') return;
        e.preventDefault();
        if (e.button === 0 && currentMediaIndex < allMediaFiles.length - 1) {
            navigateFullscreen(1);
        }
    });

    document.getElementById('fullscreenOverlay').addEventListener('contextmenu', (e) => {
        if (e.target.tagName === 'VIDEO') return;
        e.preventDefault();
        if (currentMediaIndex > 0) navigateFullscreen(-1);
    });

    document.getElementById('fullscreenOverlay').addEventListener('mousemove', resetControlsTimer);

    window.addEventListener('DOMContentLoaded', initializeGallery);
</script>
</body>
</html>
